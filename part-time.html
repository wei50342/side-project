<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WorkTracker</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Menlo', 'Monaco', 'Courier New', monospace; }
        .chip { transition: all 0.2s; }
        /* Êó•ÊõÜÊ†ºÂ≠êÁöÑÂãïÁï´ */
        .cal-day:hover { background-color: rgba(52, 211, 153, 0.1); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
    </style>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-PY0DTLM60T"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-PY0DTLM60T');
    </script>
</head>
<body class="bg-slate-950 text-slate-200 min-h-screen pb-32 selection:bg-emerald-500 selection:text-white">

    <div class="bg-slate-900/90 backdrop-blur-md border-b border-slate-800 p-4 sticky top-0 z-50 flex justify-between items-center">
        <h1 class="text-lg font-bold text-emerald-400" data-i18n="app_title">‚ö° Work_Log</h1>
        <div class="flex gap-2">
            <select id="langSelect" onchange="setLanguage(this.value)" class="text-xs bg-slate-800 text-slate-300 border border-slate-700 rounded px-1 py-1 outline-none">
                <option value="zh-TW">üáπüáº ‰∏≠</option>
                <option value="ja">üáØüáµ Êó•</option>
                <option value="en">üá∫üá∏ En</option>
            </select>
            <button onclick="copyData()" class="text-xs bg-slate-800 hover:bg-slate-700 text-emerald-400 border border-slate-700 px-3 py-1.5 rounded transition" data-i18n="btn_backup">Copy</button>
        </div>
    </div>

    <div class="max-w-md mx-auto p-4 space-y-6">

        <div class="bg-slate-900 border border-slate-800 rounded-lg p-5 shadow-2xl">
            <div class="flex justify-between items-center mb-4 border-b border-slate-800 pb-2">
                <span class="text-slate-400 text-sm font-bold" data-i18n="stats_title">DASHBOARD</span>
                <span class="text-xs text-emerald-500 cursor-pointer hover:underline" onclick="selectAllMonths()" data-i18n="select_all">[All]</span>
            </div>
            <div id="monthFilter" class="flex flex-wrap gap-2 mb-4"></div>
            <div class="bg-slate-950 rounded border border-slate-800 p-4 text-center mb-4 relative overflow-hidden group">
                <div class="absolute inset-0 bg-emerald-500/5 group-hover:bg-emerald-500/10 transition"></div>
                <p class="text-xs text-slate-500 mb-1 uppercase tracking-wider" data-i18n="total_label">Total Hours</p>
                <p class="text-4xl font-bold text-emerald-400" id="filteredTotal">0h 0m</p>
            </div>
            <canvas id="hoursChart" height="200"></canvas>
        </div>

        <div id="inputSection" class="bg-slate-900 border border-slate-800 rounded-lg p-5 shadow-lg relative transition-all duration-300">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-slate-200 font-bold flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                    <span data-i18n="input_title">Input</span>
                </h2>
                <span id="editModeBadge" class="hidden text-xs bg-yellow-900/50 text-yellow-200 border border-yellow-700 px-2 py-1 rounded" data-i18n="badge_editing">EDITING</span>
            </div>

            <div class="mb-4">
                <input type="date" id="inputDate" class="w-full p-3 border border-slate-700 rounded bg-slate-950 text-slate-200 focus:border-emerald-500 outline-none transition">
            </div>

            <div id="timeSegments" class="space-y-2 mb-4"></div>

            <button onclick="addSegment()" class="w-full mb-3 text-slate-400 text-sm py-2 border border-slate-700 border-dashed rounded hover:bg-slate-800 hover:text-emerald-400 transition" data-i18n="btn_add">
                + Add Time Block
            </button>

            <div class="flex gap-3">
                <button onclick="saveRecord()" class="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded shadow-lg transition transform active:scale-95" data-i18n="btn_save">
                    Save Record
                </button>
                <button onclick="cancelEdit()" id="cancelBtn" class="hidden px-4 bg-slate-800 text-slate-400 hover:text-white rounded border border-slate-700 transition" data-i18n="btn_cancel">Cancel</button>
            </div>
        </div>

        <div class="bg-slate-900 border border-slate-800 rounded-lg p-5 shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <button onclick="changeMonth(-1)" class="text-slate-400 hover:text-white p-2">‚óÄ</button>
                <h2 class="text-lg font-bold text-slate-200" id="calMonthYear">Loading...</h2>
                <button onclick="changeMonth(1)" class="text-slate-400 hover:text-white p-2">‚ñ∂</button>
            </div>

            <div class="grid grid-cols-7 text-center mb-2">
                <div class="text-xs text-rose-500 font-bold">Sun</div>
                <div class="text-xs text-slate-500">Mon</div>
                <div class="text-xs text-slate-500">Tue</div>
                <div class="text-xs text-slate-500">Wed</div>
                <div class="text-xs text-slate-500">Thu</div>
                <div class="text-xs text-slate-500">Fri</div>
                <div class="text-xs text-slate-500">Sat</div>
            </div>

            <div id="calendarGrid" class="grid grid-cols-7 gap-1 text-center"></div>

            <div class="flex gap-4 justify-center mt-4 text-xs text-slate-500">
                <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-emerald-500"></span> Áõ¥Áè≠</div>
                <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-rose-500"></span> ÊãÜÁè≠(‰∏≠‰ºë)</div>
            </div>
        </div>

        <div class="bg-black border border-slate-800 rounded-lg p-4 font-mono text-sm">
            <div class="flex justify-between items-center mb-2 cursor-pointer select-none" onclick="toggleImport()">
                <h2 class="text-yellow-500 font-bold">> <span data-i18n="bulk_title">Bulk Import</span></h2>
                <span id="importToggleIcon" class="text-slate-500">‚ñº</span>
            </div>
            <div id="importPanel" class="hidden mt-3">
                <p class="text-xs text-slate-500 mb-2" data-i18n="bulk_desc"># Format: MM/DD 0800-1200</p>
                <textarea id="rawInput" rows="5" class="w-full p-3 rounded bg-slate-900 border border-slate-700 text-slate-300 focus:border-yellow-500 outline-none mb-3" placeholder="12/16 0800-1200..."></textarea>
                <button onclick="parseAndSave()" class="w-full bg-yellow-600 hover:bg-yellow-500 text-black font-bold py-2 rounded transition" data-i18n="btn_run">
                    Run Script
                </button>
            </div>
        </div>

        <div class="bg-slate-900 border border-slate-800 rounded-lg p-5">
            <h2 class="text-slate-400 text-sm font-bold mb-4 border-b border-slate-800 pb-2" data-i18n="history_title">HISTORY_LOG</h2>
            <ul id="historyList" class="space-y-3"></ul>
        </div>
    </div>

    <script>
        // --- üåç i18n Dictionary ---
        const translations = {
            'zh-TW': {
                app_title: "‚ö° Âá∫Âã§Ë°®",
                btn_backup: "ÂÇô‰ªΩ",
                stats_title: "Áµ±Ë®àÂàÜÊûê",
                select_all: "[ÂÖ®ÈÅ∏]",
                total_label: "ÂçÄÈñìÁ∏ΩÂ∑•ÊôÇ",
                input_title: "Â∑•ÊôÇËº∏ÂÖ•",
                badge_editing: "‰øÆÊîπ‰∏≠",
                btn_add: "+ Â¢ûÂä†ÊôÇÊÆµ",
                btn_save: "üíæ ÂÑ≤Â≠òÁ¥ÄÈåÑ",
                btn_cancel: "ÂèñÊ∂à",
                bulk_title: "ÊâπÊ¨°ÂåØÂÖ• / ‰øÆÊîπ",
                bulk_desc: "# Ê†ºÂºè: MM/DD 0800-1200 (Â∑•‰Ωú‰∏≠: 0800-)",
                btn_run: "üöÄ Âü∑Ë°åÂåØÂÖ•",
                history_title: "Ë©≥Á¥∞Á¥ÄÈåÑ",
                status_working: "‚è≥ Â∑•‰Ωú‰∏≠",
                alert_date: "Ë´ãÈÅ∏ÊìáÊó•Êúü",
                alert_time: "Ë´ãËº∏ÂÖ•ÊôÇÈñì",
                alert_no_input: "Ë´ãËº∏ÂÖ•Ë≥áÊñô",
                alert_copied: "Ë≥áÊñôÂ∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞øÔºÅ",
                alert_updated: "ÊàêÂäüÊõ¥Êñ∞ {n} Á≠ÜË≥áÊñôÔºÅ",
                chart_label: "Â∑•ÊôÇ (Â∞èÊôÇ)",
                err_year_format: "‚ùå Âπ¥‰ªΩÊ†ºÂºèÈåØË™§ (Ë°å {line}): {content}\nÂπ¥‰ªΩÂøÖÈ†àÊòØ 4 ‰ΩçÊï∏ (YYYY)„ÄÇ",
                err_date_invalid: "‚ùå Êó•ÊúüÊï∏ÂÄºÈåØË™§ (Ë°å {line}): {content}\nÊúà‰ªΩ (1-12) ÊàñÊó•Êúü (1-31) ‰∏çÂêàÁêÜ„ÄÇ",
                err_format_general: "‚ùå Ê†ºÂºèÁÑ°Ê≥ïËæ®Ë≠ò (Ë°å {line}): {content}\nË´ã‰ΩøÁî® YYYY/MM/DD Êàñ MM/DD Ê†ºÂºè„ÄÇ",
                msg_success: "‚úÖ ÊàêÂäüÊõ¥Êñ∞ {n} Á≠ÜË≥áÊñôÔºÅ"
            },
            'ja': {
                app_title: "‚ö° Âá∫Âã§Ë°®",
                btn_backup: "‰øùÂ≠ò",
                stats_title: "Áµ±Ë®à„Éá„Éº„Çø",
                select_all: "[ÂÖ®ÈÅ∏Êäû]",
                total_label: "ÂêàË®àÊôÇÈñì",
                input_title: "ÂÖ•Âäõ„Éï„Ç©„Éº„É†",
                badge_editing: "Á∑®ÈõÜ‰∏≠",
                btn_add: "+ ÊôÇÈñì„ÇíËøΩÂä†",
                btn_save: "üíæ Ë®òÈå≤„Åô„Çã",
                btn_cancel: "ÂèñÊ∂à",
                bulk_title: "‰∏ÄÊã¨ÁôªÈå≤ / ‰øÆÊ≠£",
                bulk_desc: "# Êõ∏Âºè: MM/DD 0800-1200 (Âã§Âãô‰∏≠: 0800-)",
                btn_run: "üöÄ ÂÆüË°å",
                history_title: "Â±•Ê≠¥„É≠„Ç∞",
                status_working: "‚è≥ Âã§Âãô‰∏≠",
                alert_date: "Êó•‰ªò„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ",
                alert_time: "ÊôÇÈñì„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ",
                alert_no_input: "„Éá„Éº„Çø„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ",
                alert_copied: "„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ",
                alert_updated: "{n} ‰ª∂„ÅÆ„Éá„Éº„Çø„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„ÅüÔºÅ",
                chart_label: "ÊôÇÈñì (h)",
                err_year_format: "‚ùå Âπ¥ÂΩ¢Âºè„Ç®„É©„Éº (Ë°å {line}): {content}\nÂπ¥„ÅØ4Ê°Å (YYYY) „ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
                err_date_invalid: "‚ùå Êó•‰ªòÂÄ§„Ç®„É©„Éº (Ë°å {line}): {content}\nÊúà (1-12) „Åæ„Åü„ÅØÊó• (1-31) „Åå‰∏çÊ≠£„Åß„Åô„ÄÇ",
                err_format_general: "‚ùå ‰∏çÊòé„Å™ÂΩ¢Âºè (Ë°å {line}): {content}\nYYYY/MM/DD „Åæ„Åü„ÅØ MM/DD ÂΩ¢Âºè„Çí‰ΩøÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
                msg_success: "‚úÖ {n} ‰ª∂„ÅÆ„Éá„Éº„Çø„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„ÅüÔºÅ"
            },
            'en': {
                app_title: "‚ö° Work_Log",
                btn_backup: "Backup",
                stats_title: "DASHBOARD",
                select_all: "[All]",
                total_label: "Total Hours",
                input_title: "Input",
                badge_editing: "EDITING",
                btn_add: "+ Add Time Block",
                btn_save: "üíæ Save Record",
                btn_cancel: "Cancel",
                bulk_title: "Bulk Import",
                bulk_desc: "# Format: MM/DD 0800-1200",
                btn_run: "Run Script",
                history_title: "HISTORY_LOG",
                status_working: "‚è≥ Working",
                alert_date: "Please select a date",
                alert_time: "Please enter time",
                alert_no_input: "No Input Data",
                alert_copied: "Copied to clipboard!",
                alert_updated: "Updated {n} records.",
                chart_label: "Hours",
                err_year_format: "‚ùå Year Format Error (Line {line}): {content}\nYear must be 4 digits (YYYY).",
                err_date_invalid: "‚ùå Invalid Date (Line {line}): {content}\nCheck Month (1-12) or Day (1-31).",
                err_format_general: "‚ùå Unknown Format (Line {line}): {content}\nPlease use YYYY/MM/DD or MM/DD.",
                msg_success: "‚úÖ Successfully updated {n} records!"
            }
        };

        let currentLang = 'zh-TW';

        function initLanguage() {
            // Detect Browser Language
            const browserLang = navigator.language;
            if (browserLang.startsWith('zh')) currentLang = 'zh-TW';
            else if (browserLang.startsWith('ja')) currentLang = 'ja';
            else currentLang = 'en';
            
            // Set Dropdown Value
            document.getElementById('langSelect').value = currentLang;
            applyTranslations();
        }

        function setLanguage(lang) {
            currentLang = lang;
            applyTranslations();
            renderHistoryList(); // Refresh list to update 'Working' text
            initFilters(); // Refresh chart label
        }

        function t(key) {
            return translations[currentLang][key] || translations['en'][key];
        }

        function applyTranslations() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t(key)) el.innerText = t(key);
            });
        }

        // --- Core Vars ---
        const inputDate = document.getElementById('inputDate');
        const timeSegments = document.getElementById('timeSegments');
        const historyList = document.getElementById('historyList');
        const monthFilter = document.getElementById('monthFilter');
        const filteredTotal = document.getElementById('filteredTotal');
        const editModeBadge = document.getElementById('editModeBadge');
        const cancelBtn = document.getElementById('cancelBtn');
        const inputSection = document.getElementById('inputSection');

        let records = JSON.parse(localStorage.getItem('workRecords')) || [];
        let selectedMonths = []; 
        
        // --- Calendar Vars ---
        let calCurrentDate = new Date(); // Controls the month being viewed

        // --- Init ---
        initLanguage(); // <--- Run Language Init First
        inputDate.valueAsDate = new Date();
        addSegment();
        initFilters();
        renderHistoryList();
        renderCalendar(); // Initial Calendar Render

        // --- Calendar Logic (NEW) ---
        function renderCalendar() {
            const year = calCurrentDate.getFullYear();
            const month = calCurrentDate.getMonth(); // 0-11
            
            // Update Header
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            document.getElementById('calMonthYear').innerText = `${year} ${monthNames[month]}`;

            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';

            // Calculate days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const totalDays = lastDay.getDate();
            const startDayIndex = firstDay.getDay(); // 0(Sun) - 6(Sat)

            // 1. Previous Month Padding (Whitespace)
            for(let i = 0; i < startDayIndex; i++) {
                const div = document.createElement('div');
                div.className = "p-2"; // Empty
                grid.appendChild(div);
            }

            // 2. Days
            for(let d = 1; d <= totalDays; d++) {
                const dayStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const record = records.find(r => r.date === dayStr);
                
                const cell = document.createElement('div');
                cell.className = "cal-day p-2 rounded cursor-pointer flex flex-col items-center justify-center h-12 relative border border-transparent hover:border-slate-700 transition";
                cell.onclick = () => {
                    // Update input date and load record if exists
                    inputDate.value = dayStr;
                    if(record) loadForEdit(dayStr);
                    else {
                        // Reset form for new entry
                        cancelEdit();
                        inputDate.value = dayStr;
                    }
                };

                // Date Number
                const numSpan = document.createElement('span');
                numSpan.className = "text-sm font-mono z-10";
                numSpan.innerText = d;
                
                // Color Logic
                // If record exists:
                // segment > 1 (Split Shift) -> Red
                // segment == 1 (Straight Shift) -> Green
                if (record) {
                    const isSplit = record.segments.length > 1;
                    const isWorking = record.segments.some(s => s.includes('???'));
                    
                    const dot = document.createElement('div');
                    dot.className = `absolute bottom-1 w-1.5 h-1.5 rounded-full ${isSplit ? 'bg-rose-500 shadow-[0_0_5px_rgba(244,63,94,0.8)]' : 'bg-emerald-500 shadow-[0_0_5px_rgba(16,185,129,0.8)]'}`;
                    
                    if(isWorking) {
                        dot.className = "absolute bottom-1 w-1.5 h-1.5 rounded-full bg-yellow-400 animate-pulse";
                    }

                    cell.classList.add("bg-slate-800"); // Highlight background slightly for active days
                    cell.appendChild(dot);
                    numSpan.classList.add("text-white", "font-bold");
                } else {
                    numSpan.classList.add("text-slate-500");
                }

                // Check if Today
                const todayStr = new Date().toISOString().slice(0,10);
                if(dayStr === todayStr) {
                    cell.classList.add("border-indigo-500", "border");
                }

                cell.appendChild(numSpan);
                grid.appendChild(cell);
            }
        }

        function changeMonth(offset) {
            calCurrentDate.setMonth(calCurrentDate.getMonth() + offset);
            renderCalendar();
        }

        // --- Bulk Import ---
        function toggleImport() { document.getElementById('importPanel').classList.toggle('hidden'); }

        function parseAndSave() {
            const rawText = document.getElementById('rawInput').value;
            // Ê™¢Êü•Á©∫ÂÄº
            if(!rawText.trim()) return alert(t('alert_no_input')); 
            
            const currentYear = new Date().getFullYear();
            const lines = rawText.trim().split('\n');
            let tempRecords = [];

            // Ê≠£ÂâáË°®ÈÅîÂºè
            const regexWithYear = /^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/;
            const regexNoYear = /^(\d{1,2})[\/\-](\d{1,2})$/;

            for (let i = 0; i < lines.length; i++) {
                let line = lines[i].trim();
                if (!line) continue;

                const parts = line.split(/\s+/);
                const dateStr = parts[0]; 
                const timeRanges = parts.slice(1);
                let formattedDate = "";
                
                // --- ÈÇèËºØ A: ÊúâÂπ¥‰ªΩ (Âö¥Ê†ºÊ™¢Êü• 4 ‰ΩçÊï∏) ---
                if (regexWithYear.test(dateStr)) {
                    const match = dateStr.match(regexWithYear);
                    const y = parseInt(match[1]);
                    const m = parseInt(match[2]);
                    const d = parseInt(match[3]);
                    
                    // Êó•ÊúüÂêàÁêÜÊÄßÊ™¢Êü•
                    if (m < 1 || m > 12 || d < 1 || d > 31) {
                         alert(t('err_date_invalid').replace('{line}', i+1).replace('{content}', dateStr));
                         return; 
                    }
                    formattedDate = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;

                // --- ÈÇèËºØ B: ÁÑ°Âπ¥‰ªΩ (Ëá™ÂãïÂ∏∂ÂÖ•) ---
                } else if (regexNoYear.test(dateStr)) {
                    const match = dateStr.match(regexNoYear);
                    const m = parseInt(match[1]);
                    const d = parseInt(match[2]);
                    
                    if (m < 1 || m > 12 || d < 1 || d > 31) {
                         alert(t('err_date_invalid').replace('{line}', i+1).replace('{content}', dateStr));
                         return;
                    }

                    // Êô∫ÊÖßÂà§Êñ∑Âπ¥‰ªΩ
                    let y = currentYear;
                    const nowM = new Date().getMonth() + 1;
                    if (m > nowM + 6) y -= 1;
                    
                    formattedDate = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;

                // --- ÈÇèËºØ C: Ê†ºÂºèÈåØË™§ ---
                } else {
                    // Â¶ÇÊûúËº∏ÂÖ•‰∫Ü 2 Á¢ºÂπ¥‰ªΩ (Â¶Ç 25/01/01)ÔºåÊúÉÂà§ÂÆöÁÇ∫Ê†ºÂºèÈåØË™§ (Ë¶ÅÊ±Ç 4 Á¢º)
                    if(dateStr.match(/^\d{2}[\/\-]\d{1,2}[\/\-]\d{1,2}$/)) {
                        alert(t('err_year_format').replace('{line}', i+1).replace('{content}', dateStr));
                    } else {
                        alert(t('err_format_general').replace('{line}', i+1).replace('{content}', dateStr));
                    }
                    return;
                }

                // ÊôÇÈñìËß£Êûê (‰øùÊåÅ‰∏çËÆä)
                let dailyMin = 0;
                let segments = [];
                const fmt = t => (t && t.length === 4) ? `${t.slice(0,2)}:${t.slice(2)}` : t;

                timeRanges.forEach(range => {
                    if(!range.includes('-')) return;
                    let [rawS, rawE] = range.split('-');
                    const s = fmt(rawS);
                    if(!rawE || rawE === '???') {
                        segments.push(`${s}-???`);
                    } else {
                        const e = fmt(rawE);
                        const sMin = parseInt(s.split(':')[0])*60 + parseInt(s.split(':')[1]);
                        const eMin = parseInt(e.split(':')[0])*60 + parseInt(e.split(':')[1]);
                        let dur = eMin - sMin;
                        if(dur < 0) dur += 24*60;
                        dailyMin += dur;
                        segments.push(`${s}-${e}`);
                    }
                });

                if(segments.length > 0) {
                    tempRecords.push({ date: formattedDate, minutes: dailyMin, segments: segments, timestamp: Date.now() });
                }
            }

            tempRecords.forEach(newRec => {
                records = records.filter(r => r.date !== newRec.date);
                records.push(newRec);
            });

            records.sort((a,b) => new Date(b.date) - new Date(a.date));
            localStorage.setItem('workRecords', JSON.stringify(records));
            initFilters(); renderHistoryList(); renderCalendar(); // Refresh Calendar
            document.getElementById('rawInput').value = '';
            toggleImport();
            alert(t('msg_success').replace('{n}', tempRecords.length));
        }

        // --- GUI Logic ---
        function addSegment(s='', e='') {
            const div = document.createElement('div');
            div.className = 'time-row flex gap-2 mb-2 items-center';
            div.innerHTML = `<input type="time" value="${s}" class="start-time w-5/12 p-2 border border-slate-700 rounded bg-slate-950 text-white text-center"><span class="text-slate-500">‚ûú</span><input type="time" value="${e}" class="end-time w-5/12 p-2 border border-slate-700 rounded bg-slate-950 text-white text-center"><button onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-400 font-bold px-2 text-xl">√ó</button>`;
            timeSegments.appendChild(div);
        }

        function saveRecord() {
            const date = inputDate.value;
            if(!date) return alert(t('alert_date'));
            const starts = document.querySelectorAll('.start-time');
            const ends = document.querySelectorAll('.end-time');
            let dailyMin = 0, segs = [], hasInput = false;

            for(let i=0; i<starts.length; i++){
                const s=starts[i].value, e=ends[i].value;
                if(s){
                    hasInput = true;
                    if(e){
                        const sM=parseInt(s.split(':')[0])*60+parseInt(s.split(':')[1]);
                        const eM=parseInt(e.split(':')[0])*60+parseInt(e.split(':')[1]);
                        let d=eM-sM; if(d<0)d+=1440;
                        dailyMin+=d; segs.push(`${s}-${e}`);
                    } else { segs.push(`${s}-???`); }
                }
            }
            if(!hasInput) return alert(t('alert_time'));

            records = records.filter(r=>r.date!==date);
            records.push({date, minutes:dailyMin, segments:segs, timestamp:Date.now()});
            records.sort((a,b)=>new Date(b.date)-new Date(a.date));
            localStorage.setItem('workRecords',JSON.stringify(records));
            resetForm(); initFilters(); renderHistoryList(); renderCalendar(); // Refresh Calendar
        }
        
        // --- Filter & Display ---
        function initFilters() {
            const all = [...new Set(records.map(r=>r.date.slice(0,7)))].sort().reverse();
            if(selectedMonths.length===0 && all.length>0) selectedMonths=[all[0]];
            monthFilter.innerHTML='';
            all.forEach(m=>{
                const btn=document.createElement('button');
                const active=selectedMonths.includes(m);
                btn.className=`chip text-xs px-3 py-1.5 rounded border font-mono ${active?'bg-emerald-600 text-white border-emerald-500':'bg-slate-800 text-slate-400 border-slate-700 hover:bg-slate-700'}`;
                btn.innerText=m;
                btn.onclick=()=>toggleMonth(m);
                monthFilter.appendChild(btn);
            });
            updateStats();
        }
        function toggleMonth(m){
            selectedMonths.includes(m)?selectedMonths=selectedMonths.filter(x=>x!==m):selectedMonths.push(m);
            initFilters();
        }
        function selectAllMonths(){
            selectedMonths=[...new Set(records.map(r=>r.date.slice(0,7)))];
            initFilters();
        }
        function updateStats(){
            const tg = records.filter(r=>selectedMonths.includes(r.date.slice(0,7)));
            filteredTotal.innerText = formatMinutes(tg.reduce((a,b)=>a+b.minutes,0));
            renderChart(tg);
            renderHistoryList(tg); 
        }
        
        function renderChart(dataArr){
            const sorted = [...dataArr].sort((a,b)=>new Date(a.date)-new Date(b.date));
            const ctx = document.getElementById('hoursChart').getContext('2d');
            if(window.myChart) window.myChart.destroy();
            
            Chart.defaults.color = '#94a3b8';
            Chart.defaults.borderColor = '#1e293b';

            window.myChart = new Chart(ctx, {
                type:'bar',
                data:{
                    labels:sorted.map(r=>r.date.slice(5)),
                    datasets:[{
                        label: t('chart_label'), // Translate Chart Label
                        data:sorted.map(r=>(r.minutes/60).toFixed(1)),
                        backgroundColor:'#10b981',
                        borderRadius:2
                    }]
                },
                options:{
                    responsive:true, 
                    plugins:{legend:{display:false}}, 
                    scales:{y:{beginAtZero:true, grid:{color:'#1e293b'}}, x:{grid:{display:false}}}
                }
            });
        }
        
        function loadForEdit(d){
            const r=records.find(x=>x.date===d); if(!r)return;
            inputDate.value=r.date; timeSegments.innerHTML='';
            editModeBadge.classList.remove('hidden'); cancelBtn.classList.remove('hidden');
            inputSection.classList.add('ring-2', 'ring-emerald-500');
            r.segments.forEach(s=>{ const[st,en]=s.split('-'); addSegment(st,en==='???'?'':en); });
            window.scrollTo({top:0,behavior:'smooth'});
        }
        function cancelEdit(){ resetForm(); }
        function resetForm(){ inputDate.valueAsDate=new Date(); timeSegments.innerHTML=''; addSegment(); editModeBadge.classList.add('hidden'); cancelBtn.classList.add('hidden'); inputSection.classList.remove('ring-2', 'ring-emerald-500'); }
        
        function renderHistoryList(targetRecords){
            const listData = targetRecords || records;
            historyList.innerHTML='';
            listData.forEach(r=>{
                const li=document.createElement('li');
                const work=r.segments.some(s=>s.includes('???'));
                li.className=`flex justify-between items-center p-3 rounded border-l-4 border-t border-b border-r ${work?'bg-yellow-900/20 border-l-yellow-500 border-t-yellow-900/50 border-r-yellow-900/50 border-b-yellow-900/50':'bg-slate-900 border-l-emerald-500 border-slate-800'} transition hover:bg-slate-800`;
                
                // Translate Status
                const workingText = t('status_working');

                li.innerHTML=`<div onclick="loadForEdit('${r.date}')" class="flex-grow cursor-pointer">
                    <div class="flex items-center gap-2">
                        <span class="font-bold text-slate-200 font-mono">${r.date}</span> 
                        ${work?`<span class="text-[10px] bg-yellow-900 text-yellow-200 px-1 rounded border border-yellow-700 animate-pulse">${workingText}</span>`:''}
                    </div>
                    <div class="text-xs text-slate-500 font-mono mt-1">${r.segments.map(s=>s.replace('???','...')).join(', ')}</div>
                </div>
                <div class="font-bold text-emerald-400 font-mono">${formatMinutes(r.minutes)}</div>`;
                historyList.appendChild(li);
            });
        }
        function formatMinutes(m){ return `${Math.floor(m/60)}h ${m%60}m`; }
        function copyData(){ 
             const txt = records.map(r => `${r.date.replace(/-/g,'/').slice(5)} ${r.segments.map(s=>s.replace(':','').replace(':','')).join(' ')}`).join('\n');
             navigator.clipboard.writeText(txt).then(()=>alert(t('alert_copied')));
        }
    </script>
</body>
</html>